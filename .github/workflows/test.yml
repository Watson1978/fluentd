name: Test

on:
  push:
    branches: [v1.16]
    paths-ignore:
      - '*.md'
      - 'lib/fluent/version.rb'
  pull_request:
    branches: [v1.16]
    paths-ignore:
      - '*.md'
      - 'lib/fluent/version.rb'

concurrency:
  group: ${{ github.head_ref || github.sha }}-${{ github.workflow }}
  cancel-in-progress: true

permissions: read-all

jobs:
  repeat-test:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        ruby-version: ['3.4', '3.3', '3.2']

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby-version }}
        bundler-cache: true

    - name: Run tests repeatedly
      shell: powershell
      run: |
        # --- 設定 ---
        $testCmd = 'bundle exec ruby -I"lib;test" test\plugin\test_out_forward.rb -v -n "/test: Create new connection per send_data|test: Node with security is thread-safe on multi threads/"'

        $ignorePattern = "RuntimeError: can't find unused port"
        $maxRetries = 1000

        $batFile = ".\run_test.bat"
        $stdOutLog = ".\stdout.log"
        $stdErrLog = ".\stderr.log"
        # -----------

        for ($i=1; $i -le $maxRetries; $i++) {
            Write-Host "`n=== Run: $i / $maxRetries ==="

            # 1. バッチファイル作成
            Set-Content -Path $batFile -Value $testCmd -Encoding Ascii

            # 念のため前のログを消しておく
            if (Test-Path $stdOutLog) { Remove-Item $stdOutLog }
            if (Test-Path $stdErrLog) { Remove-Item $stdErrLog }

            $sw = [System.Diagnostics.Stopwatch]::StartNew()

            # 2. Start-Process で実行（出力先を分ける）
            $p = Start-Process -FilePath "cmd.exe" `
                -ArgumentList "/c $batFile" `
                -RedirectStandardOutput $stdOutLog `
                -RedirectStandardError $stdErrLog `
                -PassThru `
                -Wait

            $sw.Stop()
            $duration = "{0:N2}" -f $sw.Elapsed.TotalSeconds
            Write-Host "Duration: ${duration} sec"

            $exitCode = $p.ExitCode

            # 3. ログを結合して読み込む
            $fullOutput = ""
            if (Test-Path $stdOutLog) {
                $fullOutput += (Get-Content $stdOutLog -Raw)
            }
            if (Test-Path $stdErrLog) {
                $errContent = (Get-Content $stdErrLog -Raw)
                if ($errContent) {
                    $fullOutput += "`n--- STDERR ---`n" + $errContent
                }
            }

            # ログが空っぽだった場合の対策
            if (-not $fullOutput) { $fullOutput = "(No output captured)" }

            # 4. 判定ロジック
            if ($exitCode -eq 0) {
                Write-Host "Result: Success"
                Write-Host $fullOutput
            } else {
                if ($fullOutput -match $ignorePattern) {
                    Write-Host "Result: Port error detected (Ignored)"
                    Write-Host $fullOutput
                } else {
                    Write-Host "Result: Failure Detected! Stopping."
                    Write-Host "========================================"
                    Write-Host $fullOutput
                    Write-Host "========================================"
                    exit 1
                }
            }
        }
        Write-Host "`nAll runs completed."